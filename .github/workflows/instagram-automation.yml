name: Instagram Content Generator

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      month:
        description: 'M√™s para gerar conte√∫do (ex: Fevereiro)'
        required: true
        type: string
      year:
        description: 'Ano'
        required: true
        default: '2026'
        type: string
  
  # Autom√°tico dia 25 de cada m√™s
  schedule:
    - cron: '0 23 25 * *'  # 23h UTC = 20h BRT dia 25

jobs:
  generate-content:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd automation
          npm install
      
      - name: Generate topics
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd automation
          node scripts/1-generate-topics.js "${{ github.event.inputs.month || 'pr√≥ximo m√™s' }}" "${{ github.event.inputs.year || '2026' }}"
      
      - name: Create HTML posts
        run: |
          cd automation
          node scripts/2-create-html.js
      
      - name: Generate screenshots
        run: |
          cd automation
          node scripts/3-screenshots.js
      
      - name: Generate captions
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd automation
          node scripts/4-generate-captions.js
      
      - name: Upload to Google Drive
        env:
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
        run: |
          cd automation
          node scripts/5-upload-drive.js
      
      - name: Trigger Make.com scheduling
        env:
          MAKE_WEBHOOK_URL: ${{ secrets.MAKE_WEBHOOK_URL }}
        run: |
          cd automation
          node scripts/6-trigger-make.js
      
      - name: Upload generated files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: instagram-content-${{ github.event.inputs.month }}
          path: automation/generated/
          retention-days: 30
      
      - name: Notify completion
        run: |
          echo "‚úÖ Conte√∫do gerado com sucesso!"
          echo "üìÅ Arquivos salvos no Google Drive"
          echo "üìÖ Make.com iniciou agendamento autom√°tico"