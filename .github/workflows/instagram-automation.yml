name: Instagram Automation

# QUANDO EXECUTAR
on:
  # 1. MANUAL: BotÃ£o "Run workflow" na aba Actions
  workflow_dispatch:
    inputs:
      month:
        description: 'MÃªs para gerar posts (ex: Fevereiro)'
        required: true
        default: 'Fevereiro'
        type: string
  
  # 2. AUTOMÃTICO: Todo dia 25 Ã s 20h (BrasÃ­lia) 
  schedule:
    - cron: '0 23 25 * *'  # 23:00 UTC = 20:00 BRT

jobs:
  generate-and-schedule:
    name: Gerar Posts e Agendar Instagram
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout repositÃ³rio
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      # 2. Setup Node.js
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      # 3. Instalar dependÃªncias
      - name: ğŸ“¦ Instalar dependÃªncias
        working-directory: ./automation
        run: |
          npm install
          npx puppeteer browsers install chrome
      
      # 4. Criar arquivo .env com secrets
      - name: ğŸ”‘ Configurar variÃ¡veis
        working-directory: ./automation
        run: |
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "GOOGLE_DRIVE_CREDENTIALS=${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}" >> .env
          echo "GOOGLE_DRIVE_FOLDER_ID=${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}" >> .env
          echo "MAKE_WEBHOOK_URL=${{ secrets.MAKE_WEBHOOK_URL }}" >> .env
          echo "TIMEZONE=America/Sao_Paulo" >> .env
          echo "NODE_ENV=production" >> .env
      
      # 5. Criar credentials.json Google Drive
      - name: ğŸ“ Criar Google Drive Credentials
        working-directory: ./automation
        run: |
          echo '${{ secrets.GOOGLE_DRIVE_CREDENTIALS_JSON }}' > google-credentials.json
          echo "GOOGLE_DRIVE_CREDENTIALS=./google-credentials.json" >> .env
      
      # 6. Executar pipeline completo
      - name: ğŸš€ Executar AutomaÃ§Ã£o
        working-directory: ./automation
        run: |
          MONTH="${{ inputs.month || 'Fevereiro' }}"
          echo "ğŸ“… Gerando posts para: $MONTH"
          npm run generate:all $MONTH
      
      # 7. Upload artifacts (backup)
      - name: ğŸ“Š Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: instagram-posts-${{ inputs.month || 'auto' }}
          path: |
            automation/generated/**/*
          retention-days: 30
      
      # 8. NotificaÃ§Ã£o sucesso
      - name: âœ… Sucesso
        if: success()
        run: |
          echo "ğŸ‰ Pipeline executado com sucesso!"
          echo "ğŸ“Š Verifique Google Drive e Instagram Creator Studio"
      
      # 9. NotificaÃ§Ã£o erro
      - name: âŒ Erro
        if: failure()
        run: |
          echo "âš ï¸ Pipeline falhou. Verifique logs acima."
          exit 1
