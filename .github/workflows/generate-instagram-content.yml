name: ğŸ¨ Gerador AutomÃ¡tico Instagram Posts

on:
  workflow_dispatch:
    inputs:
      month:
        description: 'MÃªs para gerar conteÃºdo (ex: Fevereiro)'
        required: true
        default: 'Fevereiro'
      year:
        description: 'Ano'
        required: true
        default: '2026'
      total_posts:
        description: 'NÃºmero de posts'
        required: true
        default: '28'
  
  schedule:
    # Roda automaticamente dia 25 de cada mÃªs Ã s 20h (UTC-3 = 23h UTC)
    - cron: '0 23 25 * *'

env:
  NODE_VERSION: '18'

jobs:
  generate-content:
    name: ğŸ“¸ Gerar Posts Instagram
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ”§ Instalar dependÃªncias
        working-directory: ./automation/instagram
        run: npm ci
      
      - name: ğŸ¯ ETAPA 1 - Gerar TÃ³picos (Gemini AI)
        working-directory: ./automation/instagram
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ¤– Gerando ${{ github.event.inputs.total_posts || '28' }} tÃ³picos para ${{ github.event.inputs.month || 'prÃ³ximo mÃªs' }}..."
          node scripts/1-generate-topics.js "${{ github.event.inputs.month }}" "${{ github.event.inputs.year }}" "${{ github.event.inputs.total_posts }}"
      
      - name: ğŸ¨ ETAPA 2 - Criar HTMLs dos Posts
        working-directory: ./automation/instagram
        run: |
          echo "ğŸ¨ Criando arquivos HTML com design Prismatic..."
          node scripts/2-create-html.js
      
      - name: ğŸ“¸ ETAPA 3 - Gerar Screenshots (Puppeteer)
        working-directory: ./automation/instagram
        run: |
          echo "ğŸ“¸ Gerando screenshots 1080x1080..."
          node scripts/3-screenshots.js
      
      - name: âœï¸ ETAPA 4 - Gerar Legendas (Gemini AI)
        working-directory: ./automation/instagram
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "âœï¸ Criando legendas otimizadas..."
          node scripts/4-generate-captions.js
      
      - name: â˜ï¸ ETAPA 5 - Upload Google Drive
        working-directory: ./automation/instagram
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
        run: |
          echo "â˜ï¸ Fazendo upload para Google Drive..."
          node scripts/5-upload-drive.js
      
      - name: ğŸš€ ETAPA 6 - Trigger Make.com (Agendamento)
        working-directory: ./automation/instagram
        env:
          MAKE_WEBHOOK_URL: ${{ secrets.MAKE_WEBHOOK_URL }}
        run: |
          echo "ğŸš€ Disparando webhook Make.com para agendamento..."
          node scripts/6-trigger-make.js
      
      - name: ğŸ“Š Upload Artifacts (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: instagram-content-${{ github.event.inputs.month || 'auto' }}-${{ github.event.inputs.year || '2026' }}
          path: |
            automation/instagram/generated/
          retention-days: 30
      
      - name: âœ… Sucesso!
        run: |
          echo "âœ… CONCLUÃDO!"
          echo "ğŸ“¸ Posts gerados: ${{ github.event.inputs.total_posts || '28' }}"
          echo "ğŸ“… PerÃ­odo: ${{ github.event.inputs.month || 'AutomÃ¡tico' }} ${{ github.event.inputs.year || '2026' }}"
          echo "â˜ï¸ Armazenado: Google Drive"
          echo "ğŸ“… Agendados: Make.com â†’ Instagram"
          echo ""
          echo "ğŸ¯ PrÃ³xima aÃ§Ã£o: ZERO! Tudo automÃ¡tico ğŸš€"
