name: Vendedor AI - Super Sistema 24/7

on:
  schedule:
    # Roda todo dia as 9h (horario de Brasilia = 12h UTC)
    - cron: '0 12 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Acao para executar'
        required: true
        default: 'followup'
        type: choice
        options:
          - followup
          - scout
          - analyze
      lead_username:
        description: 'Username do lead (para analyze)'
        required: false
        type: string
      nicho:
        description: 'Nicho para Scout (infoprodutores, ecommerce, agencias)'
        required: false
        default: 'infoprodutores'
        type: string

jobs:
  # JOB 1: Prospeccao Automatica (Scout)
  scout-leads:
    name: Scout de Novos Leads
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'scout')
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Instalar dependencias
        run: |
          cd vendedor
          npm install
      - name: Executar Scout AI
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          cd vendedor
          node 6-scout.js "${{ github.event.inputs.nicho || 'infoprodutores' }}" 15
      - name: Salvar leads no repositorio
        run: |
          git config --global user.email "jarvis@prismatic-labs.com"
          git config --global user.name "JARVIS AI"
          git add vendedor/data/
          git diff --staged --quiet || git commit -m "auto: Novos leads qualificados encontrados $(date +'%Y-%m-%d')"
          git push || true

  # JOB 2: Followup Diario
  daily-followup:
    name: Verificar Followups do Dia
    runs-on: ubuntu-latest
    needs: scout-leads
    if: always() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'followup'))
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Instalar dependencias
        run: |
          cd vendedor
          npm install
      - name: Executar Followup AI
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          cd vendedor
          node 4-followup.js
      - name: Salvar logs no repositorio
        run: |
          git config --global user.email "jarvis@prismatic-labs.com"
          git config --global user.name "JARVIS AI"
          git add vendedor/data/
          git diff --staged --quiet || git commit -m "auto: Followup diario executado $(date +'%Y-%m-%d')"
          git push || true

  # JOB 3: Analise Manual via UI
  analyze-lead:
    name: Analise de Lead Especifico
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'analyze' && github.event.inputs.lead_username != ''
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Instalar dependencias
        run: |
          cd vendedor
          npm install
      - name: Analisar e Gerar DM
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          cd vendedor
          node 1-analyzer.js "${{ github.event.inputs.lead_username }}"
          node 2-copywriter.js "${{ github.event.inputs.lead_username }}"
          node 3-cataloger.js add "${{ github.event.inputs.lead_username }}"
      - name: Salvar dados no repositorio
        run: |
          git config --global user.email "jarvis@prismatic-labs.com"
          git config --global user.name "JARVIS AI"
          git add vendedor/data/
          git diff --staged --quiet || git commit -m "feat: Lead @${{ github.event.inputs.lead_username }} analisado"
          git push || true
